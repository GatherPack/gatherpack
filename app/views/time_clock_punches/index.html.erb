<% breadcrumb :time_clock_punches %>

<%= search_form_for @q, data: {"controller": "turbo_search", "turbo-frame": "results"} do |f| %>
<div class="card">
  <div class="card-header">
    <h1>Time Clock</h1>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col">
        <%= f.input :person_display_name_cont, label: 'Person' %>
      </div>
      <div class="col">
        <%= f.input :start_time_gteq, label: 'From', as: :datetime %>
      </div>
      <div class="col">
        <%= f.input :start_time_lteq, label: 'To', as: :datetime  %>
      </div>
      <div class="col">
        <%= f.input :time_clock_period_id_eq, label: 'Periods', as: :select, collection: policy_scope(TimeClockPeriod) %>
      </div>
    </div>
  </div>
  <div class="card-footer">
    <%= link_to "New Time Clock Punch", new_time_clock_punch_path, class: 'btn btn-success' %>
    <%= link_to "Time Clock Periods", time_clock_periods_path, class: 'btn btn-primary' %>
    <%= f.submit 'Search', class: 'btn btn-primary', data: { action: "turbo_search#search" } %>
    <%= link_to 'Clear Search', request.path, class: "btn btn-dark", data: { action: "turbo_search#clear" } %>
  </div>
</div>
<% end %>

<%= turbo_frame_tag "results" do %>
  <%#= TODO CAN WE DO A PRETTIER TABLE?! %>
  <div class="card">
    <div class="card-body">
      <table class="table">
        <thead>
        <tr class="table-primary">
          <th scope="col"><h3>Person</h3></th>
          <th scope="col"><h3>Start Time</h3></th>
          <th scope="col"><h3>End Time</h3></th>
          <th scope="col"><h3>Hours</h3></th>
          <th scope="col"><h3>Period</h3></th>
          <% if current_user.person.manager? %>
            <th scope="col"><h3>Actions</h3></th>
          <% end %>
        </tr>
        </thead>
        <tbody>
          <% @time_clock_punches.order(end_time: :desc).each do |time_clock_punch| %>
            <tr>
              <td><%= link_to time_clock_punch.person.display_name, time_clock_punch.person, class: 'btn btn-primary' %></td>
              <td><%= time_clock_punch.start_time.strftime('%m/%d/%Y %I:%M%p') %></td>
              <% if time_clock_punch.end_time.present? %>
                <td><%= time_clock_punch.end_time.strftime('%m/%d/%Y %I:%M%p') %></td>
                <td><%= ((time_clock_punch.end_time - time_clock_punch.start_time) / 3600 * 20).round / 20.0 %></td>
              <% else %>
                <td>Still Clocked In</td>
                <td><%= ((Time.now - time_clock_punch.start_time) / 3600 * 20).round / 20.0 %></td>
              <% end %>
              <td><%= time_clock_punch.time_clock_period.name unless time_clock_punch.time_clock_period.nil? %></td>
              <% if current_user.person.manager? %>
                <td>
                  <%= link_to 'Edit', edit_time_clock_punch_path(time_clock_punch), class: 'btn btn-warning' %>
                  <%= link_to 'Delete', time_clock_punch, class: 'btn btn-danger', data: { turbo_method: :delete, turbo_confirm: 'Are you sure?' } %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <%= paginate @time_clock_punches %>
<% end %>
